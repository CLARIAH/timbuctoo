<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="./graphiql/graphiql.css" />

    <style>
      html {
        height: 100%;
      }
      body {
        height: 100%;
        margin: 0;
        width: 100%;
        overflow: hidden;
      }
      #graphiql {
        height: 100vh;
      }
      .CodeMirror-hint {
        max-width: none;
      }

    </style>
    <script src="./graphiql/es6-promise.auto.min.js"></script>
    <script src="./graphiql/fetch.min.js"></script>
    <script src="./graphiql/react.js"></script>
    <script src="./graphiql/react-dom.js"></script>
    <script src="./graphiql/graphiql.js"></script>

  </head>
  <body>
    <div id="graphiql">Loading...</div>
    <script>
      var acceptMediaType = "application/json";
      var mediaTypeMenuItems = [];

      function setAcceptMediaType(mediaType) {
          acceptMediaType = mediaType;
      }
      
      function graphQLFetcher(graphQLParams) {
        return fetch("/v5/graphql", {
          method: 'post',
          headers: { 'Accept': acceptMediaType, 'Content-Type': "application/json" },
          body: JSON.stringify({ query: graphQLParams.query})
        }).then(function (response) {
          var s;
          var contentType = response.headers.get('Content-Type');
          if(contentType === 'application/json' || contentType.endsWith("+json")) {
            s = response.json();
          } else {
            s = response.text();
          }
          return s
        }).then(function (parsed) {
          var data = parsed;
          return data;
        });
      }

      
      fetch("/v5/graphql?query={availableExportMimetypes{name}}", {
          method: 'get',
          headers: {'Accept': 'application/json'}
      }).then(function (mediaTypes) {
          return mediaTypeMenuItems = mediaTypes.json();
      }).then(function (mediaTypes) {
          return mediaTypes.data.availableExportMimetypes.map(function (type) {
              return React.createElement(GraphiQL.MenuItem, {
                  key: type.name,
                  onSelect: function () {
                      setAcceptMediaType(type.name);
                  },
                  label: type.name
              })
          })
      }).then(function (newMenuItems) {
          mediaTypeMenuItems = newMenuItems;
          reRender();
      });
      function reRender() {
          ReactDOM.render(React.createElement(GraphiQL,
              {
                  fetcher: graphQLFetcher,
              },
              React.createElement(
                  GraphiQL.Toolbar,
                  null,
                  React.createElement(
                      GraphiQL.Menu,
                      {label: "select accept media type"},
                      mediaTypeMenuItems
                  ),
              )
          ), document.getElementById("graphiql"))
      }
    </script>
  </body>
</html>
